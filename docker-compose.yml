version: "3.9"
services:
  
  tests: &tests
    image: python:3.8-slim-buster
    working_dir: /app
    volumes:
      - ./app.py:/app/app.py
      - ./requirements.txt:/app/requirements.txt
    command: bash -c "pip3 install -r requirements.txt && pytest app.py"      
    # command: tail -f /dev/null # run indefinitely

  tests_with_code_climate:
    <<: *tests
    environment:
      - CC_TEST_REPORTER_ID=$CC_TEST_REPORTER_ID
      - GITHUB_SHA=$GITHUB_SHA
      - GITHUB_REF_NAME=$GITHUB_REF_NAME
      - GIT_BRANCH=$GIT_BRANCH
    volumes:
      # - .git:/app/.git  # will cause issues in GHA
      - ./app.py:/app/app.py
      - ./requirements.txt:/app/requirements.txt
      - ./code_climate.sh:/app/code_climate.sh
    command: bash code_climate.sh